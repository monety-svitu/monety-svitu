<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Монети Світу</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; padding-right: 260px; }
    h1 { margin: 0 0 10px; }
    .muted { color:#777; font-size: 12px; }

    #filters { display:flex; gap:10px; flex-wrap:wrap; margin: 10px 0 15px; }
    #filters input, #filters select, #filters button { padding: 6px 8px; font-size: 14px; }
    #filters button { cursor:pointer; }

    .coin { border:1px solid #ddd; padding:12px; margin-bottom:10px; border-radius:10px; }
    .coinTitle { font-weight: 800; font-size: 18px; margin: 0 0 6px; }
    .coinRow { display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; align-items:center; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#f2f2f2; font-size: 12px; }
    .price { font-weight: 900; }
    .btn { padding: 6px 10px; cursor:pointer; }
    .btnAdd { background:#111; color:#fff; border:0; border-radius: 8px; }
    .btnAdd[disabled] { opacity:0.5; cursor:not-allowed; }

    #cart {
      position: fixed; right: 20px; top: 20px; width: 220px;
      background:#f7f7f7; padding:12px; border-radius:12px; border:1px solid #ddd;
    }
    #cart h3 { margin: 0 0 10px; }
    #cartItems { margin: 10px 0; font-size: 14px; }
    .cartRow { display:flex; justify-content:space-between; gap:8px; margin-bottom:6px; }
    .cartRow button { border:0; background:transparent; cursor:pointer; }
    .total { font-weight: 900; margin-top:10px; }
    .btnCheckout { width:100%; padding:10px; border:0; border-radius:10px; background: #f0c040; font-weight:900; cursor:pointer; }
    .btnCheckout:disabled { opacity:0.5; cursor:not-allowed; }

    .empty { padding: 20px; border: 1px dashed #ccc; border-radius: 10px; }
  </style>
</head>
<body>

  <h1>Монети Світу</h1>
  <div class="muted">Пошук працює по назві та Krause (KM#...).</div>

  <div id="filters">
    <input id="q" type="text" placeholder="Пошук: назва, KM#..." />

    <select id="fCountry">
      <option value="">Всі країни</option>
    </select>

    <select id="fMetal">
      <option value="">Всі метали</option>
    </select>

    <select id="fCondition">
      <option value="">Будь-який стан</option>
    </select>

    <select id="sort">
      <option value="new">Нові (як у списку)</option>
      <option value="price_asc">Ціна ↑</option>
      <option value="price_desc">Ціна ↓</option>
      <option value="title_asc">Назва A→Я</option>
    </select>

    <label style="display:flex;align-items:center;gap:6px;">
      <input id="onlyInStock" type="checkbox" checked />
      Тільки в наявності
    </label>

    <button id="reset">Скинути</button>
  </div>

  <div id="coins"></div>

<div id="cart">
  <h3>Кошик</h3>

  <div id="cartItems"></div>

  <hr>

  <div style="display:flex; flex-direction:column; gap:6px;">
    <input id="cName" placeholder="Ваше ім'я" style="padding:6px;">
    <input id="cPhone" placeholder="Телефон" style="padding:6px;">
    <input id="cCity" placeholder="Місто" style="padding:6px;">

    <label style="font-size:12px; margin-top:6px;">Доставка</label>
    <select id="cDelivery" style="padding:6px;" onchange="syncDeliveryUI()">
      <option value="NovaPoshta">Нова пошта</option>
      <option value="UkrPoshta">Укрпошта</option>
    </select>

    <div id="npBlock" style="display:flex; flex-direction:column; gap:6px;">
      <select id="npType" style="padding:6px;">
        <option value="Branch">Відділення</option>
        <option value="Postomat">Поштомат</option>
      </select>
      <input id="npNumber" placeholder="№ відділення / поштомата" style="padding:6px;">
    </div>

    <div id="upBlock" style="display:none; flex-direction:column; gap:6px;">
      <input id="upAddress" placeholder="Адреса / відділення Укрпошти" style="padding:6px;">
    </div>

    <label style="font-size:12px; margin-top:6px;">Зв’язок</label>
    <select id="cChannel" style="padding:6px;">
      <option value="Viber">Viber</option>
      <option value="Telegram">Telegram</option>
    </select>

    <textarea id="cComment" placeholder="Коментар (необов’язково)" rows="2" style="padding:6px;"></textarea>

    <button onclick="checkout()" style="padding:8px 10px; margin-top:6px;">Оформити</button>

    <div id="checkoutMsg" style="font-size:12px; margin-top:6px;"></div>
  </div>
</div>

<script>
  // ВАЖЛИВО:
  // /api/coins -> повертає JSON масив монет
  // /api/order -> приймає POST і створює замовлення (у тебе вже працює)
  const API_COINS = "/api/coins";
  const API_ORDER = "/api/order";

  let allCoins = [];
  let viewCoins = [];
  let cart = []; // масив монет (кожен елемент = 1шт)

  function norm(v) {
    return String(v ?? "").toLowerCase().trim();
  }

  function uniq(arr) {
    return [...new Set(arr.filter(Boolean))].sort((a,b)=>String(a).localeCompare(String(b), "uk"));
  }

  function money(n) {
    const x = Number(n) || 0;
    return Math.round(x);
  }

  async function loadCoins() {
    try {
      const res = await fetch(COINS_API);
      const text = await res.text();

      // якщо раптом прийшла HTML-помилка — покажемо коротко
      if (text.trim().startsWith("<")) {
        console.error("Coins API returned HTML:", text.slice(0, 400));
        alert("Помилка: /api/coins повернув HTML (не JSON). Відкрий F12 → Console.");
        return;
      }

      allCoins = JSON.parse(text);

      fillFilterOptions();
      applyFilters(); // це намалює список

    } catch (e) {
      console.error("loadCoins error:", e);
      alert("Помилка завантаження монет. Відкрий F12 → Console.");
    }
  }

  function fillFilterOptions() {
    const country = document.getElementById("fCountry");
    const metal = document.getElementById("fMetal");
    const cond = document.getElementById("fCondition");

    // очистити (залишити перший option)
    country.innerHTML = `<option value="">Всі країни</option>`;
    metal.innerHTML = `<option value="">Всі метали</option>`;
    cond.innerHTML = `<option value="">Будь-який стан</option>`;

    uniq(allCoins.map(c => c.Country)).forEach(v => {
      const o = document.createElement("option");
      o.value = v; o.textContent = v;
      country.appendChild(o);
    });

    uniq(allCoins.map(c => c.Metal)).forEach(v => {
      const o = document.createElement("option");
      o.value = v; o.textContent = v;
      metal.appendChild(o);
    });

    uniq(allCoins.map(c => c.Condition)).forEach(v => {
      const o = document.createElement("option");
      o.value = v; o.textContent = v;
      cond.appendChild(o);
    });
  }

  function applyFilters() {
    const q = norm(document.getElementById("q").value);
    const fCountry = document.getElementById("fCountry").value;
    const fMetal = document.getElementById("fMetal").value;
    const fCondition = document.getElementById("fCondition").value;
    const onlyInStock = document.getElementById("onlyInStock").checked;
    const sort = document.getElementById("sort").value;

    viewCoins = allCoins.filter(c => {
      if (onlyInStock && Number(c.Quantity) <= 0) return false;
      if (fCountry && c.Country !== fCountry) return false;
      if (fMetal && c.Metal !== fMetal) return false;
      if (fCondition && c.Condition !== fCondition) return false;

      if (q) {
        const hay = [
          c.TitleUA, c.TitleEN, c.KrauseNumber, c.Country, c.Metal, c.Theme, c.Condition
        ].map(norm).join(" ");
        if (!hay.includes(q)) return false;
      }
      return true;
    });

    // сортування
    if (sort === "price_asc") viewCoins.sort((a,b)=> money(a.PriceUAH)-money(b.PriceUAH));
    if (sort === "price_desc") viewCoins.sort((a,b)=> money(b.PriceUAH)-money(a.PriceUAH));
    if (sort === "title_asc") viewCoins.sort((a,b)=> String(a.TitleUA||"").localeCompare(String(b.TitleUA||""), "uk"));

    renderCoins();
  }

  function renderCoins() {
    const container = document.getElementById("coins");
    container.innerHTML = "";

    if (!viewCoins.length) {
      container.innerHTML = `<div class="empty">Нічого не знайдено</div>`;
      return;
    }

    viewCoins.forEach(c => {
      const inStock = Number(c.Quantity) > 0;

      const div = document.createElement("div");
      div.className = "coin";
      div.innerHTML = `
        <div class="coinTitle">${c.TitleUA || ""}</div>
        <div class="muted">
          ${c.Country ? `<span class="pill">${c.Country}</span>` : ""}
          ${c.Metal ? `<span class="pill">${c.Metal}</span>` : ""}
          ${c.Condition ? `<span class="pill">${c.Condition}</span>` : ""}
          ${c.KrauseNumber ? `<span class="pill">${c.KrauseNumber}</span>` : ""}
        </div>

        <div class="coinRow">
          <div class="price">${money(c.PriceUAH)} грн</div>
          <div class="muted">${inStock ? `В наявності: ${c.Quantity}` : `Немає в наявності`}</div>
          <button class="btn btnAdd" ${inStock ? "" : "disabled"} onclick="addToCart(${c.ID})">Додати</button>
        </div>
      `;
      container.appendChild(div);
    });
  }

  function addToCart(id) {
    const coin = allCoins.find(x => String(x.ID) === String(id));
    if (!coin) return;

    // 1 монета = 1 шт. Додаємо як позицію.
    cart.push(coin);
    renderCart();
  }

  function removeFromCart(index) {
    cart.splice(index, 1);
    renderCart();
  }

  function renderCart() {
    const container = document.getElementById("cartItems");
    container.innerHTML = "";

    if (!cart.length) {
      container.innerHTML = `<div class="muted" style="margin-top:10px;">Кошик пустий</div>`;
    } else {
      cart.forEach((c, i) => {
        const row = document.createElement("div");
        row.className = "cartRow";
        row.innerHTML = `
          <div style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
            ${c.TitleUA || ""} <span class="muted">(${money(c.PriceUAH)} грн)</span>
          </div>
          <button title="Видалити" onclick="removeFromCart(${i})">✖</button>
        `;
        container.appendChild(row);
      });
    }

    const total = cart.reduce((sum, c) => sum + money(c.PriceUAH), 0);
    document.getElementById("cartTotal").textContent = money(total);

    document.getElementById("checkoutBtn").disabled = cart.length === 0;
  }

function syncDeliveryUI() {
  const d = document.getElementById("cDelivery").value;
  document.getElementById("npBlock").style.display = (d === "NovaPoshta") ? "flex" : "none";
  document.getElementById("upBlock").style.display = (d === "UkrPoshta") ? "flex" : "none";
}

// Виклик після завантаження сторінки
syncDeliveryUI();

async function checkout() {
  const msg = document.getElementById("checkoutMsg");
  msg.textContent = "";

  if (cart.length === 0) {
    alert("Кошик пустий");
    return;
  }

  const name = document.getElementById("cName").value.trim();
  const phone = document.getElementById("cPhone").value.trim();
  const city = document.getElementById("cCity").value.trim();

  const deliveryService = document.getElementById("cDelivery").value;
  const channel = document.getElementById("cChannel").value;
  const comment = document.getElementById("cComment").value.trim();

  let deliveryDetails = "";

  if (!name || !phone || !city) {
    alert("Заповни: ім'я, телефон, місто");
    return;
  }

  if (deliveryService === "NovaPoshta") {
    const npType = document.getElementById("npType").value; // Branch / Postomat
    const npNumber = document.getElementById("npNumber").value.trim();
    if (!npNumber) {
      alert("Вкажи № відділення або поштомата Нової пошти");
      return;
    }
    deliveryDetails = (npType === "Branch" ? "Відділення" : "Поштомат") + " №" + npNumber;
  } else {
    const upAddress = document.getElementById("upAddress").value.trim();
    if (!upAddress) {
      alert("Вкажи адресу або відділення Укрпошти");
      return;
    }
    deliveryDetails = upAddress;
  }

  const total = cart.reduce((sum, c) => sum + Math.round(Number(c.PriceUAH || 0)), 0);

  // ✅ ВАЖЛИВО: відправляємо на /api/order (а не на /api/coins)
  // Переконайся, що вгорі файлу є:
  // const API_ORDER = "/api/order";
  if (typeof API_ORDER === "undefined") {
    alert("Не знайдено API_ORDER. Додай: const API_ORDER = '/api/order';");
    return;
  }

  msg.textContent = "Відправляю замовлення...";

  const payload = {
    name,
    phone,
    email: "",
    city,
    deliveryService,     // NovaPoshta / UkrPoshta
    deliveryDetails,     // Відділення/Поштомат №... або адреса
    channel,             // Viber / Telegram
    comment,
    items: cart.map(c => ({ ID: c.ID, TitleUA: c.TitleUA, PriceUAH: Math.round(Number(c.PriceUAH || 0)) })),
    totalUAH: total,
    paymentMethod: "Card"
  };

  try {
    const r = await fetch(API_ORDER, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const text = await r.text();
    let resp;
    try { resp = JSON.parse(text); } catch { resp = { raw: text }; }

    if (r.ok && resp && (resp.success === true || resp.orderId || resp.id)) {
      alert("Замовлення прийнято! Ми зв'яжемось з вами для уточнень.");
      cart = [];
      renderCart();
      await loadCoins();
      msg.textContent = "";
    } else {
      console.log("Order not OK:", r.status, resp);
      msg.textContent = "Помилка створення замовлення. Дивись F12 → Console.";
      alert("Не вийшло створити замовлення. Спробуй ще раз.");
    }
  } catch (e) {
    console.log("checkout error:", e);
    msg.textContent = "Помилка мережі. Дивись F12 → Console.";
    alert("Помилка мережі. Спробуй ще раз.");
  }
}

  // події фільтрів
  document.getElementById("q").addEventListener("input", applyFilters);
  document.getElementById("fCountry").addEventListener("change", applyFilters);
  document.getElementById("fMetal").addEventListener("change", applyFilters);
  document.getElementById("fCondition").addEventListener("change", applyFilters);
  document.getElementById("onlyInStock").addEventListener("change", applyFilters);
  document.getElementById("sort").addEventListener("change", applyFilters);

  document.getElementById("reset").addEventListener("click", () => {
    document.getElementById("q").value = "";
    document.getElementById("fCountry").value = "";
    document.getElementById("fMetal").value = "";
    document.getElementById("fCondition").value = "";
    document.getElementById("sort").value = "new";
    document.getElementById("onlyInStock").checked = true;
    applyFilters();
  });

  // старт
  loadCoins();
</script>

</body>
</html>
